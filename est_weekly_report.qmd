---
title: "ECOSS Surveillance Tool (EST)"
subtitle: "Week `r lubridate::isoweek(lubridate::floor_date(lubridate::today(), unit = 'week', week_start = 1)-7)` summary report" 
author: "Matthew Hoyle"
date: "`r format(Sys.Date(), '%d %B %Y')`"

embed-resources: true

format: 
  html:
    toc: true
    toc_float: true
  #pdf: default

editor: visual

title-block-banner: "#3F3685"
title-block-style: manuscript

execute: 
  echo: false
  warning: false
  freeze: true
---

```{r setup, include=FALSE}

pacman::p_load(tidyverse, surveillance, glue, gt, gtExtras, quartabs, here, arrow,
               grates, ggiraph)


load(here::here("data/model_data.rds"))


# Set Theme
old <- theme_set(theme_bw(base_family = "Arial"))


report_week <- lubridate::isoweek(lubridate::floor_date(lubridate::today(), unit = "week", week_start = 1)-7)

pathogens <- names(plot_list) |> 
  set_names()

hb_vec <- names(plot_list$Adenovirus) |> 
  set_names()
```

## Model Outputs

### Alarms Raised

```{r alarms_stats}
hb_with_outbreaks <- alarms_this_week |> 
  filter(unit != "overall") |> 
  pull(unit) |> 
  unique()
```

In week `r report_week`, alarms were raised in `r length(hb_with_outbreaks)` out of 15 NHS Scotland health boards: `r knitr::combine_words(hb_with_outbreaks)`.

```{r alarms_table}
alarms_this_week |>
  select(hb2019name, organism, observed, expected, upperbound, rate) |> 
  gt(groupname_col = "hb2019name", row_group_as_column = TRUE) |> 
  cols_label(organism = "ECOSS Pathogen",
             observed = "Observed",
             expected = "Expected",
             upperbound = "Alarm Threshold",
             rate = "Rate*") |> 
  tab_footnote(footnote = "* Incidence rate (per 100,000 population)") |>
  tab_options(row_group.default_label = "Health Board") |> 
  opt_interactive(use_search = TRUE, use_highlight = TRUE, use_compact_mode = TRUE, use_pagination = FALSE)
```

### Scotland

```{r national plots}
#| results: asis
national_plots <- plot_list |> 
  map(\(x) 
      keep_at(x, "overall")) |> 
  list_flatten()

tibble(
  organism = pathogens,
  plots = c(national_plots)
) |> 
  quartabs::render_tabset(tabset_vars = organism, output_vars = plots, pills = TRUE)

```

### Health Boards

```{r hb plots}
#| results: asis
#| fig-width: 12
#| fig-height: 8


tibble(
  organism = pathogens,
  plots = c(
    plot_list_faceted |>
      map(\(x) 
          x + labs(title = NULL,
       subtitle = NULL)
       )
    )
  ) |> 
  quartabs::render_tabset(tabset_vars = organism, output_vars = plots, pills = TRUE)

```

## Interactive Plots

```{r interactive national plots}
#| results: asis

tooltip_css <- "background-color:#3F3685;font-family:Arial;color:white;padding:5px;border-radius:3px;"


national_iplots <- iplot_list |>
  map(\(x)
      keep_at(x, "overall")) |>
  list_flatten() |> 
  map(\(x)
      ggiraph::girafe(ggobj = x,
                options = list(
                  opts_tooltip(css = tooltip_css, offx = 15, offy = 15, opacity = 1),
                  opts_sizing(width = .8),
                  opts_hover(css = ''),
                  opts_hover_inv(css ='opacity:0.8;fill:lightgrey;')
                  )
                )
      )

tibble(
  organism = pathogens,
  plots = c(national_iplots)
) |>
  quartabs::render_tabset(tabset_vars = organism, output_vars = plots, pills = TRUE)

# ggiraph::girafe(ggobj = iplot_list$`Influenza A(H3)`$overall,
#                 options = list(
#                   opts_tooltip(css = tooltip_css, offx = 15, offy = 15, opacity = 1),
#                   opts_sizing(width = 1),
#                   opts_hover(css = ''),
#                   opts_hover_inv(css ='opacity:0.8;fill:lightgrey;')
#                 )
# )
```

## Weekly alarms by health board

```{r}
historic_alarms |> 
  mutate(unit = factor(unit, levels = hb_vec)) |> 
  group_by(week_date, unit) |> 
  count() |> 
  ggplot(aes(x = week_date, y = n, fill = unit)) +
  geom_col() +
  labs(x = "ISO Week",
       y = "Count",
       fill = "Health Board")
```

------------------------------------------------------------------------

![](_extensions/phs-html-quarto/phs-logo.png){.column-margin fig-align="right"}
